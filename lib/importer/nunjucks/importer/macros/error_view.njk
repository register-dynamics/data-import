{% from "importer/macros/table_view.njk" import tableView %}

{#
    importerErrorView displays errors from the result of a mapping attempt.

    These errors are grouped so that similar errors in the same column are
    shown together, and each side of the error there should also be a single
    row of non-erroring data for context where possible.

    The expected error/warning structure from the API is as follows:

    [
        {
          message: "An error occurred",
          fields: ["A"],
          rows: [["A", "B", "C"]] }
        },
        {
          message: "A warning is necessary",
          fields: ["B"],
            rows: [["A"]]
        }
    ]

#}
{% macro importerErrorView(session, results ) %}
    {% set tableHeaders =  importerHeaderRowDisplay(session, "source") %}

    <p class="govuk-body">
        During import there were <strong>{{results.errorCount}}</strong> errors and <strong>{{results.warningCount}}</strong> warnings.
    </p>

    {% if results.errors.length > 0 %}
        <h2 class="govuk-heading-m">Errors</h2>
        {% for error in results.errors %}
            <div class="govuk-form-group govuk-form-group--error">
                <h2 class="govuk-heading-m validation-error-message">{{error.message}}</h2>
                <p class="govuk-body">This error occurs {{error.meta.count | count_string}} in your data. The first time at row {{ error.meta.first}}:</p>

                {{ tableView( {
                        caption: false,
                        showHeaders: true,
                        headers: tableHeaders,
                        showRowNumbers: true,
                        rows: error.rows,
                        moreRowsCount: 0
                    } )
                }}
            </div>
        {% endfor %}
    {% endif %}

    {% if results.warnings.length > 0 %}
        <h2 class="govuk-heading-m">Warnings</h2>
        {% for warning in results.warnings %}
            <div class="govuk-form-group govuk-form-group--error">
                <h2 class="govuk-heading-m validation-error-message">{{warning.message}}</h2>
                <p class="govuk-body">This warning occurs {{warning.meta.count | count_string}} in your data. The first time at row {{ warning.meta.first}}:</p>


                {{ tableView( {
                        caption: false,
                        showHeaders: true,
                        headers: tableHeaders,
                        showRowNumbers: true,
                        rows: warning.rows,
                        moreRowsCount: 0
                    } )
                }}
            </div>
        {% endfor %}
    {% endif %}

{% endmacro %}


