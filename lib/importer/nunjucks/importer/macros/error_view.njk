{% from "importer/macros/table_view.njk" import dudkTableView %}

{# Deprecated: use dudkErrorView instead #}
{% macro importerErrorView(session, results ) %}
    {{ dudkErrorView({session: session, results: results} ) }}
{% endmacro %}


{#
    dudkErrorView displays errors from the result of a mapping attempt.

    These errors are grouped so that similar errors in the same column are
    shown together, and each side of the error there should also be a single
    row of non-erroring data for context where possible.

    The expected error/warning structure from the API is as follows:

    [
        {
          message: "An error occurred",
          fields: ["A"],
          rows: [["A", "B", "C"]] }
        },
        {
          message: "A warning is necessary",
          fields: ["B"],
            rows: [["A"]]
        }
    ]

#}
{% macro dudkErrorView(params ) %}
    {% set data = params.session %}
    {% set results = params.results %}
    {% set tableHeaders =   importerHeaderRowDisplay(data, "source") %}

    <p class="govuk-body">
        During import there were <strong>{{results.errorCount}}</strong> errors and <strong>{{results.warningCount}}</strong> warnings.
    </p>

{{ results.errors | debug }}
    {% if results.errors.length > 0 %}
        <h1 class="govuk-heading-l">Errors</h1>
        {% for error in results.errors %}
            <div class="govuk-form-group govuk-form-group--error">
                <h2 class="govuk-heading-m validation-error-message">{{error.message}}</h2>
                <p class="govuk-body">This error occurs {{error.meta.count | count_string}} in your data. The first time at row {{ error.meta.first}}:</p>

                {{ dudkTableView( {
                        caption: false,
                        showHeaders: true,
                        headers: tableHeaders,
                        showRowNumbers: true,
                        rows: error.rows,
                        moreRowsCount: 0
                    } )
                }}
            </div>
        {% endfor %}
    {% endif %}

    {% if results.warnings.length > 0 %}
        <h1 class="govuk-heading-l">Warnings</h1>
        {% for warning in results.warnings %}
            <div class="govuk-form-group govuk-form-group--error">
                <h2 class="govuk-heading-m validation-error-message">{{warning.message}}</h2>
                <p class="govuk-body">This warning occurs {{warning.meta.count | count_string}} in your data. The first time at row {{ warning.meta.first}}:</p>


                {{ dudkTableView( {
                        caption: false,
                        showHeaders: true,
                        headers: tableHeaders,
                        showRowNumbers: true,
                        rows: warning.rows,
                        moreRowsCount: 0
                    } )
                }}
            </div>
        {% endfor %}
    {% endif %}

{% endmacro %}


