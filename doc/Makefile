PLATFORM := $(shell uname)
ifeq (${PLATFORM}, Darwin)
SED_INPLACE_FLAG = -i ''
endif
SED_INPLACE_FLAG ?= -i

HQ ?= $(shell which hq)
ifeq (${HQ},)
$(error "No hq on the PATH? https://github.com/ludovicianul/hq/releases/tag/hq-1.3.2")
endif

SOURCES := $(wildcard ../lib/importer/assets/docs/*.html)
IMAGES := $(wildcard ../lib/importer/assets/docs/*.png)
OBJECTS := $(subst ../lib/importer/assets/docs/,./,${SOURCES})

# Create a list of all of the assets the pages need, by looking at the scripts
# and stylesheets they intended to download.
assets.txt: ${SOURCES}
	(echo $^ | xargs -n1 | xargs -I INPUT ${HQ} -r '[data-plugin-only]' -f INPUT -a src 'script[src]'; \
	 echo $^ | xargs -n1 | xargs -I INPUT ${HQ} -r '[data-plugin-only]' -f INPUT -a href 'link[rel=stylesheet]'; \
         echo ${IMAGES} | sed 's_\.\./lib/importer/assets/docs/_./_') | \
		sort -u | grep . > $@

# Now build a Makefile dependency include, specifying the correct download
# location for each asset and that we require it for a complete package.
assets.mk: assets.txt
	for ASSET in $$(cat assets.txt); do \
		export SRC=$$(echo $$ASSET | sed 's:^[^\/]:/plugin-assets/%40register-dynamics%2Fimporter/assets/docs/.:'); \
		printf "all: $$(basename $$ASSET)\n"; \
		printf "%s: SRC=%s\n\n" $$(basename $$ASSET) $$SRC; \
	done > $@

.PHONY: all
all: ${OBJECTS} | assets.txt # Rewrite all of the asset paths to be local now.
	for ASSET in $$(cat assets.txt); do \
		sed ${SED_INPLACE_FLAG} -e "s:$$ASSET:$$(basename $$ASSET):" ${OBJECTS}; \
	done
	for PATCH in $$(find . -name '*.patch'); do \
		patch --forward --dry-run $$(basename $$PATCH .patch) $$PATCH && patch --forward $$(basename $$PATCH .patch) $$PATCH || true; \
	done
include assets.mk

# We can generate the .gitignore from all of the things we know we are going to
# end up with in the root dir.
.gitignore: assets.txt
	(cat $^; printf '%s\n' ${OBJECTS}; echo assets.mk) | xargs -n1 basename > $@
all: .gitignore

# Download the page and remove any elements marked only for plugin use.
%.html: ../lib/importer/assets/docs/%.html
	curl --fail -sL http://localhost:3000/$(subst ../lib/importer/,/plugin-assets/%40register-dynamics%2Fimporter/,$^) | \
		${HQ} -r '[data-plugin-only]' -o $@ html

# Download the asset. This is the easiest way to get the real thing, as some of
# them (e.g. application.css) are generated by the Prototype Kit and can't just
# be copied from the disk.
%.css %.js %.png:
	curl --fail-with-body -o $@ -sL http://localhost:3000${SRC} || cat $@

.PHONY: clean
clean:
	-cat .gitignore | xargs $(RM)
	-$(RM) assets.mk assets.txt
